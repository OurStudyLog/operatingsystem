
작성자 : 김용재 


## 장치 컨트롤러와 장치 드라이버 
---

컴퓨터는 CPU 메모리 뿐만 아니라 입출력 장치와 보조기억 장치가 컴퓨터에 매달려있다.
장치 컨트롤러와 장치 드라이버 개념을 통해 외부장치와 내부가 연결되고 소통되는지 안다.
보조기억 장치또한 입출력 장치의 한 종류로 볼 수 있다.

![](입출력장치_전체.png)

### 장치 컨트롤러의 역할

- CPU와 입출력장치 간의 통신중개
    
    - 각 장치마다 규격화를 해주는 역할
- 오류 검출
    
- 데이터 버퍼링
    
    - 버퍼링 : 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 버퍼라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법
        
    - 예를 들어, CPU는 전송률이 높기 때문에 버퍼에 저장하고 입출력장치로 조금씩 내보내거나 입출력장치의 데이터를 버퍼에 저장하여 한번에 CPU로 전송함으로 데이터 전송률을 맞추는 역할
        

### 장치 컨트롤러의 구조

![](입출력장치_장치컨트롤러구조.png)

장치 컨트롤러는 결국 버스(입출력)에 연결된다.
주고 받는 정보에는 크게 데이터, 상태, 제어 3가지가 존재한다.
상태와 제어 레지스터는 하나의 레지스터로 사용되기도 한다.

데이터 레지스터는 CPU와 입출력장치 사이에 주고 받을 데이터를 저장하는 레지스터로 버퍼의 역할을 한다.
최근에는 입출력장치와 CPU간의 주고 받는 데이터가 증가하여 RAM을 사용하기도 한다.

상태 레지스터는 입출력장치가 입출력 작업할 준비가 되었는지, 작업 완료가 되었는지, 오류가 없는지 등의 상태 정보를 저장하는 레지스터이다.
제어 레지스터는 입출력장치가 수행할 내용에 대한 제어 정보가 담기는 레지스터이다.

### 장치 드라이버

장치 드라이버는 장치 컨트롤러의 동작을 감지하고 제어하는 프로그램이다.
장치 컨트롤러가 입출력장치를 연결하는 하드웨어적 통로라면, 장치 드라이버는 소프트웨어적인 통로이다.

우리가 새로운 프린터를 구입해서 컴퓨터에 연결하고 사용하려고 할때, 알맞은 장치 드라이버를 설치하는 것처럼, 컴퓨터가 연결된 입출력 장치의 드라이버를 인식하고 실행할 수 있다면 컴퓨터 내부와 정보를 주고받을 수 있다.

결국 장치 드라이버는 CPU가 장치 컨트롤러에 연결된 장치를 어떻게 제어하고 동작시킬지 알려주는 프로그램이다.
조금 더 정확하게 표현하자면 장치 드라이버를 인식하고 실행시켜주는 주체는 컴퓨터라기 보다 **운영체제**가 담당한다.

## 다양한 입출력 방법 
---

입출력 작업을 수행하기 위해 장치 컨트롤러는 3가지 방식으로 CPU와 정보를 주고받는다.
프로그램 입출력 ,입터럽트 기반 입출력 , DMA 입출력 방식이 있다. 

### 프로그램 입출력 

- 프로그램 속 명령어로 입출력장치를 제어하는 방법
- CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하여 수행
- CPU가 장치 컨트롤러의 레지스터 값을 읽고 씀으로써 이루어진다.

ex) 메모리에 저장된 정보를 하드 디스크에 백업하는 과정!

![image](입출력장치_프로그램입출력_1.png)
![](입출력장치_프로그램입출력_2.png)![](입출력장치_프로그램입출력_3.png)

- CPU가 레지스터들(입출력장치들의 주소)을 아는 방법은 2가지 있다. 
- 메모리 맵 입출력과 고립형 입출력 방식이 있다. 
#### 메모리 맵 입출력 

- 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법  
    ![](입출력장치_메모리맵입출력_1.png)  
- 메모리 맵 입출력 방식에서 CPU는 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 다룬다.
    ![](입출력장치_메모리맵입출력_2.png)

#### 고립형 입출력 
- 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법  
    ![](입출력장치_고립형입출력_1.png)  
- CPU가 메모리 읽기/쓰기 선이 활성화되는 명령어를 실행하면 메모리에 접근하고, 입출력장치 읽기/쓰기 선이 활성화되면 명령어를 실행하면 장치 컨트롤러에 접근
    즉, 사용 목적에 따라 전용 명령어가 있음
    ![](입출력장치_고립형입출력_2.png)

### 인터럽트 기반 입출력 

- 말 그대로 인터럽트를 기반으로 하는 입출력
- 입출력장치에 의한 하드웨어 인터럽트는 정확히 말하면 입출력장치가 아닌 장치 컨트롤러에 의해 발생  
      
      
    CPU가 장치 컨트롤러에 입출력 작업 명령  
    ↓  
    장치 컨트롤러가 입출력장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 작업 가능  
    ↓  
    장치 컨트롤러가 입출력 작업 완료하고 CPU에게 인터럽트 요청 신호 보냄  
    ↓  
    CPU 하던 작업 백업시키고 인터럽트 서비스 루틴 실행  
    ![](https://velog.velcdn.com/images/thdgusrbek/post/0ab40cb6-aec5-47a3-aa36-daacb9b9ba61/image.png)  
-  동시에 여러 인터럽트가 발생할 경우 

![](https://velog.velcdn.com/images/thdgusrbek/post/919a141d-d054-448c-95a4-29172efa6be2/image.png)간단한 방법: 순차적으로 처리  
하지만, 현실적으로 모든 인터럽트를 순차적으로 처리할 순 없다.
- 이유
    - NMI(Non Mask Interrupt)가 발생하면 우선순위가 높은 인터럽트부터 처리되기 때문.
    - 플래그 레지스터 속 인터럽트 비트가 활성화되어있는 경우
![](https://velog.velcdn.com/images/thdgusrbek/post/91dbed9e-f4e6-4720-975e-c9095fa6a7db/image.png)![](https://velog.velcdn.com/images/thdgusrbek/post/ae5fa008-5219-4fd7-813c-5b03adeabdc7/image.png)

#### 우선순위 반영 인터럽트 처리 

프로그래머블 인터럽트 컨트롤러(PIC)라는 하드웨어를 사용  

- PIC
    - 여러 장치 컨트롤러에 연결됨
    - 장치 컨트롤러의 하드웨어 인터럽트의 우선순위 판단해줌 (`NMI` 우선순위는 판단 안함)
    - CPU에게 지금 처리해야 할 인터럽트 알려줌

        ![](https://velog.velcdn.com/images/thdgusrbek/post/b19e6e36-2a63-4ac5-afa1-1c93db8b8cf3/image.png)![](https://velog.velcdn.com/images/thdgusrbek/post/7c33bf76-5bc3-49b6-967f-48417afb5696/image.png)
### DMA 입출력

- 모든 데이터 이동은 cpu가 주도, 반드시 cpu를 거침 
- 직접 메모리에 접근 할 수 있는 입출력 기능 ( Direct Memory Access)
- 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요  
- CPU가 일시적으로 시스템버스를 이용하지 않을때 시스템버스를 이용함 
    ![](https://velog.velcdn.com/images/thdgusrbek/post/e3a1959b-90ac-4119-b214-d632e153db6c/image.png)  
    

#### 과정

CPU는 DMA 컨트롤러에 입출력 작업을 명령  
↓  
DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행  
(필요하면 DMA 컨트롤러는 메모리에 직접 접근)  
↓  
입출력 작업이 끝나면 DMA 컨트롤러는 인터럽트를 통해 CPU에 작업이 끝났음을 알림  
![](https://velog.velcdn.com/images/thdgusrbek/post/70bdf450-fac5-436e-a776-4aef3b405150/image.png)![](https://velog.velcdn.com/images/thdgusrbek/post/5fe592f8-d6ca-4a59-b66f-3f95bf6f6086/image.png)![](https://velog.velcdn.com/images/thdgusrbek/post/9e31816f-9067-4a8f-9f43-19a97ee7e5e0/image.png)

### 입출력 버스

시스템 버스를 너무 자주 이용하는 DMA 컨트롤러 
그래서, 시스템 버스 이용 빈도를 낮추기 위해 입출력 버스가 생김  
ex)  
`PCI 버스`, `PCI express (PCIe) 버스` 등등
![](https://velog.velcdn.com/images/thdgusrbek/post/93ef0797-f33e-4290-9fae-28aa1395e3bc/image.png)![](https://velog.velcdn.com/images/thdgusrbek/post/83381cb0-f7af-4979-8040-3384340bce28/image.png)